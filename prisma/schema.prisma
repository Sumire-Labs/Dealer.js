generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id // Discord User ID
  chips          BigInt        @default(10000)
  bankBalance    BigInt        @default(0)
  totalWon       BigInt        @default(0)
  totalLost      BigInt        @default(0)
  totalGames     Int           @default(0)
  dailyStreak    Int           @default(0)
  lastDaily      DateTime?
  lastInterestAt DateTime?
  bankruptAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  transactions   Transaction[]
  bets           RaceBet[]
  loans          Loan[]
  workLevel      Int           @default(0)
  workXp         Int           @default(0)
  lastWorkAt     DateTime?
  workStreak     Int           @default(0)
  lotteryTickets LotteryTicket[]
  achievements   UserAchievement[]
  activeTitle       String?
  activeBadge       String?
  lifetimeShopSpend BigInt        @default(0)
  inventory         UserInventory[]
  activeBuffs       ActiveBuff[]
  workMastery       WorkMastery[]
  weeklyChallenges  WorkWeeklyChallenge[]
  business          Business?
  collections       UserCollection[]
  fixedDeposits     FixedDeposit[]
}

model Transaction {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation(fields: [userId], references: [id])
  type         TransactionType
  game         GameType?
  amount       BigInt // positive = win, negative = loss
  balanceAfter BigInt
  metadata     Json?
  createdAt    DateTime        @default(now())

  @@index([userId, createdAt])
}

model RaceSession {
  id        String     @id @default(cuid())
  channelId String
  status    RaceStatus @default(BETTING)
  horses    Json // Horse[]
  results   Json? // RaceResult[]
  startsAt  DateTime // betting deadline
  createdAt DateTime   @default(now())
  bets      RaceBet[]

  @@index([channelId, status])
}

model RaceBet {
  id         String      @id @default(cuid())
  sessionId  String
  session    RaceSession @relation(fields: [sessionId], references: [id])
  userId     String
  user       User        @relation(fields: [userId], references: [id])
  horseIndex Int
  amount     BigInt
  createdAt  DateTime    @default(now())

  @@unique([sessionId, userId]) // 1 bet per session per user
}

model Loan {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  principal BigInt
  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([userId, paidAt])
}

enum TransactionType {
  WIN
  LOSS
  DAILY
  ADMIN_GIVE
  ADMIN_RESET
  LOAN_BORROW
  LOAN_REPAY
  BANKRUPTCY
  BANK_DEPOSIT
  BANK_WITHDRAW
  BANK_TRANSFER_SEND
  BANK_TRANSFER_RECV
  BANK_INTEREST
  LOTTERY_BUY
  LOTTERY_WIN
  HEIST_JOIN
  HEIST_WIN
  HEIST_LOSS
  WORK_EARN
  MISSION_REWARD
  SHOP_BUY
  SHOP_REFUND
  WEEKLY_CHALLENGE_REWARD
  BUSINESS_COLLECT
  BUSINESS_INVEST
  BUSINESS_SALARY
  BUSINESS_SELL
  SHOP_RECYCLE
  SHOP_CRAFT
  GIFT_SEND
  GIFT_RECEIVE
  FIXED_DEPOSIT_CREATE
  FIXED_DEPOSIT_MATURE
  FIXED_DEPOSIT_EARLY_WITHDRAW
}

enum GameType {
  SLOTS
  BLACKJACK
  HORSE_RACE
  COINFLIP
  POKER
  LOTTERY
  HEIST
  ROULETTE
}

model BotSetting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

enum RaceStatus {
  BETTING
  RUNNING
  FINISHED
  CANCELLED
}

enum LotteryStatus {
  OPEN
  DRAWING
  COMPLETED
}

model LotteryRound {
  id             String        @id @default(cuid())
  roundNumber    Int           @unique @default(autoincrement())
  status         LotteryStatus @default(OPEN)
  jackpot        BigInt        @default(0)
  winningNumbers Int[]
  drawAt         DateTime
  drawnAt        DateTime?
  createdAt      DateTime      @default(now())
  tickets        LotteryTicket[]

  @@index([status])
}

model LotteryTicket {
  id        String       @id @default(cuid())
  roundId   String
  round     LotteryRound @relation(fields: [roundId], references: [id])
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  numbers   Int[]
  createdAt DateTime     @default(now())

  @@index([roundId, userId])
}

model DailyMission {
  id         String   @id @default(cuid())
  userId     String
  missionKey String
  progress   Int      @default(0)
  target     Int
  reward     BigInt
  completed  Boolean  @default(false)
  date       String   // "2026-02-21"
  createdAt  DateTime @default(now())

  @@unique([userId, missionKey, date])
  @@index([userId, date])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  achievementId String
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
}

model UserInventory {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  itemId     String
  quantity   Int       @default(1)
  everOwned  Boolean   @default(true)
  expiresAt  DateTime?
  acquiredAt DateTime  @default(now())

  @@unique([userId, itemId])
  @@index([userId])
}

model ActiveBuff {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  buffId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([userId, buffId])
  @@index([userId, expiresAt])
}

model WorkMastery {
  id              String @id @default(cuid())
  userId          String
  user            User   @relation(fields: [userId], references: [id])
  jobId           String
  shiftsCompleted Int    @default(0)
  masteryLevel    Int    @default(0)

  @@unique([userId, jobId])
  @@index([userId])
}

model WorkWeeklyChallenge {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  weekStart    String   // "2026-W08"
  challengeKey String
  target       Int
  progress     Int      @default(0)
  completed    Boolean  @default(false)
  reward       BigInt
  createdAt    DateTime @default(now())

  @@unique([userId, challengeKey, weekStart])
  @@index([userId, weekStart])
}

model Business {
  id              String             @id @default(cuid())
  ownerId         String             @unique
  owner           User               @relation(fields: [ownerId], references: [id])
  type            String
  level           Int                @default(1)
  lastCollectedAt DateTime           @default(now())
  totalEarned     BigInt             @default(0)
  createdAt       DateTime           @default(now())
  employees       BusinessEmployee[]
}

model BusinessEmployee {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  userId     String
  hiredAt    DateTime @default(now())

  @@unique([businessId, userId])
  @@index([userId])
}

model FixedDeposit {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id])
  amount       BigInt
  termDays     Int       // 7 or 30
  interestRate BigInt    // 預入時の適用利率(計算済み)
  depositedAt  DateTime  @default(now())
  maturesAt    DateTime
  withdrawnAt  DateTime?

  @@index([userId, withdrawnAt])
  @@index([maturesAt, withdrawnAt])
}

model UserCollection {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  collectionKey String
  completedAt   DateTime @default(now())

  @@unique([userId, collectionKey])
  @@index([userId])
}
