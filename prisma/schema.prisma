generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id // Discord User ID
  chips          BigInt        @default(10000)
  bankBalance    BigInt        @default(0)
  totalWon       BigInt        @default(0)
  totalLost      BigInt        @default(0)
  totalGames     Int           @default(0)
  dailyStreak    Int           @default(0)
  lastDaily      DateTime?
  lastInterestAt DateTime?
  bankruptAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  transactions   Transaction[]
  bets           RaceBet[]
  loans          Loan[]
  workLevel      Int           @default(0)
  workXp         Int           @default(0)
  lastWorkAt     DateTime?
  workStreak     Int           @default(0)
  lotteryTickets LotteryTicket[]
  achievements   UserAchievement[]
}

model Transaction {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation(fields: [userId], references: [id])
  type         TransactionType
  game         GameType?
  amount       BigInt // positive = win, negative = loss
  balanceAfter BigInt
  metadata     Json?
  createdAt    DateTime        @default(now())

  @@index([userId, createdAt])
}

model RaceSession {
  id        String     @id @default(cuid())
  channelId String
  status    RaceStatus @default(BETTING)
  horses    Json // Horse[]
  results   Json? // RaceResult[]
  startsAt  DateTime // betting deadline
  createdAt DateTime   @default(now())
  bets      RaceBet[]

  @@index([channelId, status])
}

model RaceBet {
  id         String      @id @default(cuid())
  sessionId  String
  session    RaceSession @relation(fields: [sessionId], references: [id])
  userId     String
  user       User        @relation(fields: [userId], references: [id])
  horseIndex Int
  amount     BigInt
  createdAt  DateTime    @default(now())

  @@unique([sessionId, userId]) // 1 bet per session per user
}

model Loan {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  principal BigInt
  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([userId, paidAt])
}

enum TransactionType {
  WIN
  LOSS
  DAILY
  ADMIN_GIVE
  ADMIN_RESET
  LOAN_BORROW
  LOAN_REPAY
  BANKRUPTCY
  BANK_DEPOSIT
  BANK_WITHDRAW
  BANK_TRANSFER_SEND
  BANK_TRANSFER_RECV
  BANK_INTEREST
  LOTTERY_BUY
  LOTTERY_WIN
  HEIST_JOIN
  HEIST_WIN
  HEIST_LOSS
  WORK_EARN
  MISSION_REWARD
}

enum GameType {
  SLOTS
  BLACKJACK
  HORSE_RACE
  COINFLIP
  POKER
  LOTTERY
  HEIST
  ROULETTE
}

model BotSetting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

enum RaceStatus {
  BETTING
  RUNNING
  FINISHED
  CANCELLED
}

enum LotteryStatus {
  OPEN
  DRAWING
  COMPLETED
}

model LotteryRound {
  id             String        @id @default(cuid())
  roundNumber    Int           @unique @default(autoincrement())
  status         LotteryStatus @default(OPEN)
  jackpot        BigInt        @default(0)
  winningNumbers Int[]
  drawAt         DateTime
  drawnAt        DateTime?
  createdAt      DateTime      @default(now())
  tickets        LotteryTicket[]

  @@index([status])
}

model LotteryTicket {
  id        String       @id @default(cuid())
  roundId   String
  round     LotteryRound @relation(fields: [roundId], references: [id])
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  numbers   Int[]
  createdAt DateTime     @default(now())

  @@index([roundId, userId])
}

model DailyMission {
  id         String   @id @default(cuid())
  userId     String
  missionKey String
  progress   Int      @default(0)
  target     Int
  reward     BigInt
  completed  Boolean  @default(false)
  date       String   // "2026-02-21"
  createdAt  DateTime @default(now())

  @@unique([userId, missionKey, date])
  @@index([userId, date])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  achievementId String
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
}
